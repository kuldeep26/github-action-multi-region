name: Terraform Plan
on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Select the region'
        required: true
        default: 'us-east-1'
        options:
          - "eu-west-1"
          - "us-east-1"
          - "ap-northeast-1"

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Determine branch name
        id: branch-name
        run: echo "::set-output name=branch::$(echo $GITHUB_REF | sed 's/refs\/heads\///')"

      - name: Determine tfvar file
        id: tfvar-file
        run: |
          branch_name=${{ steps.branch-name.outputs.branch }}
          region=${{ github.event.inputs.region }}
          tfvar_file="${branch_name}-${region}.tfvar"
          echo "::set-output name=tfvar_file::$tfvar_file"
          cat $tfvar_file

      - name: Terraform init
        run: terraform init

      - name: Terraform plan
        run: terraform plan -var-file=${{ steps.tfvar-file.outputs.tfvar_file }}
