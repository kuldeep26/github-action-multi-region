name: Terraform Plan
on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Select the region'
        required: true
        default: 'us-east-1'

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Determine branch name
        id: branch-name
        run: echo "::set-output name=branch::$(echo $GITHUB_REF | sed 's/refs\/heads\///')"

      - name: Determine account ID
        id: account-id
        run: |
          branch_name=${{ steps.branch-name.outputs.branch }}
          if [ "$branch_name" == "main" ]; then
            environment="dev"
            account_id="1234"
          elif [ "$branch_name" == "staging" ]; then
            account_id="5678"
          elif [ "$branch_name" == "production" ]; then
            account_id="9012"
          else
            echo "::error::Invalid branch selected"
            exit 1
          fi
          echo "::set-output name=account_id::$account_id"

      - name: Determine tfvar file
        id: tfvar-file
        run: |
          branch_name=${{ steps.branch-name.outputs.branch }}
          account_id=${{ steps.account-id.outputs.account_id }}
          region=${{ github.event.inputs.region }}
          tfvar_file="${branch_name}-${region}.tfvar"
          echo "::set-output name=tfvar_file::$tfvar_file"
          echo "::set-output name=account_id::$account_id"
          cat $tfvar_file

      - name: Show Terraform Variables
        run: |
          echo "TFVar File: ${{ steps.set-variables.outputs.tfvar_file }}"
          echo "Account ID: ${{ steps.set-variables.outputs.account_id }}"
